<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Sistema de Monitoramento</title>

  <!-- Bootstrap 5 CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Bootstrap Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
  <link rel="stylesheet" href="assets/css/style.css" />
</head>

<body class="bg-light">

  <!-- Cabe√ßalho (modernizado: bot√µes de navega√ß√£o integrados) -->
  <header class="navbar navbar-expand-lg navbar-dark bg-dark-blue shadow-sm">
    <div class="container-fluid d-flex justify-content-between align-items-center">

      <!-- Logo e T√≠tulo -->
      <div class="d-flex align-items-center">
        <i class="bi bi-building me-2 fs-4"></i>
        <span class="navbar-brand mb-0 h1 fw-bold">Sistema de Monitoramento de Seguran√ßa</span>
      </div>

      <!-- Navega√ß√£o Central -->
      <nav id="main-nav" class="d-none d-lg-flex gap-2">
        <button id="nav-monitoring" class="nav-btn btn btn-outline-light">
          <i class="bi bi-display me-1"></i>Central de Monitoramento
        </button>
        <button id="nav-cadastro" class="nav-btn btn btn-outline-light">
          <i class="bi bi-person-gear me-1"></i>Gest√£o de Recursos
        </button>
        <button id="nav-zones" class="nav-btn btn btn-outline-light">
          <i class="bi bi-map me-1"></i>Gest√£o de √Åreas
        </button>
      </nav>

      <!-- Informa√ß√µes do Usu√°rio e Logout -->
      <div class="d-flex align-items-center gap-3">
        <span class="nav-text text-white-50 small" id="user-info">Projeto Acad√™mico</span>
        <button class="btn btn-outline-light btn-sm" id="logout-btn" style="display: none;">
          <i class="bi bi-box-arrow-right"></i>
        </button>
      </div>

    </div>
  </header>

  <!-- Navega√ß√£o (migrada para o header para layout mais limpo) -->

  <!-- Conte√∫do Principal -->
  <main class="container-fluid px-3 mt-4">
    <section id="view-root" class="row">
      <!-- As se√ß√µes ser√£o renderizadas dinamicamente -->
      <div class="col-12 text-center py-5">
        <div class="spinner-border text-primary" role="status">
          <span class="visually-hidden">Carregando...</span>
        </div>
        <p class="mt-3 text-muted">Carregando sistema...</p>
      </div>
    </section>
  </main>

  <!-- Rodap√© -->
  <footer class="footer bg-dark text-white py-4 mt-5">
    <div class="container-fluid px-4">
      <div class="row">
        <div class="col-md-6">
          <h6 class="text-warning">Sistema de Monitoramento de Seguran√ßa em Obras</h6>
          <p class="small mb-2">Projeto acad√™mico desenvolvido na disciplina de Desenvolvimento de Sistemas Web.</p>
          <p class="small text-muted">Simula√ß√£o local ‚Äî dados persistidos via localStorage.</p>
        </div>
        <div class="col-md-6 text-md-end">
          <p class="small mb-1"><strong>Institui√ß√£o:</strong> [Nome da Universidade]</p>
          <p class="small mb-1"><strong>Curso:</strong> Engenharia de Software</p>
          <p class="small mb-1"><strong>Semestre:</strong> 2024.1</p>
        </div>
      </div>
      <hr class="my-3">
      <div class="text-center small text-muted">
        &copy; 2024 ‚Äî Projeto desenvolvido exclusivamente para fins acad√™micos
      </div>
    </div>
  </footer>

  <!-- Bootstrap 5 JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <!-- Scripts do Projeto -->
  <!-- Models -->
  <script src="js/models/authModel.js"></script>
  <script src="js/models/areasModel.js"></script>
  <script src="js/models/accessControlModel.js"></script>
  <script src="js/models/mapModel.js"></script>
  <script src="js/models/peopleModel.js"></script>
  <script src="js/models/devicesModel.js"></script>

  <!-- Views (APENAS as necess√°rias) -->
  <script src="js/views/authView.js"></script>
  <script src="js/views/mapView.js"></script>
  <script src="js/views/monitoringView.js"></script>
  <script src="js/views/cadastro.js"></script>
  <script src="js/views/zonesManagement.js"></script>

  <!-- Controllers -->
  <script src="js/controllers/mapController.js"></script>
  <script src="js/controllers/peopleController.js"></script>
  <script src="js/controllers/devicesController.js"></script>

  <!-- Router e Inicializa√ß√£o -->
  <script>
    // Vari√°vel para armazenar a view atual
    let currentView = null;
    
    // Router simples
    const Router = {
      async show(name) {
        console.log('Mudando para view:', name);
        
        // IMPORTANTE: Limpar a view anterior antes de carregar nova
        if (currentView && typeof currentView.cleanup === 'function') {
          console.log('üßπ Limpando view anterior...');
          currentView.cleanup();
          currentView = null;
        }
        
        // Atualizar bot√µes de navega√ß√£o
        document.querySelectorAll('.nav-btn').forEach(button => {
          button.classList.remove('active');
          // Assegurar que o estilo padr√£o seja o de contorno claro
          if (!button.classList.contains('btn-outline-light')) {
            button.classList.add('btn-outline-light');
          }
        });
        
        const activeBtn = document.getElementById('nav-' + name);
        if (activeBtn) {
          activeBtn.classList.add('active');
          activeBtn.classList.remove('btn-outline-light');
        }

        // Carregar view apropriada
        if (name === 'monitoring') {
          if (typeof MonitoringView !== 'undefined') {
            await MonitoringView.render();
            currentView = MonitoringView; // Armazenar refer√™ncia
          } else {
            console.error('MonitoringView n√£o encontrada');
            document.getElementById('view-root').innerHTML = '<div class="alert alert-danger">Erro: MonitoringView n√£o carregada</div>';
          }
        }
        
        if (name === 'cadastro') {
          if (typeof CombinedView !== 'undefined') {
            await CombinedView.render();
            currentView = CombinedView; // Armazenar refer√™ncia
          } else {
            console.error('CombinedView n√£o encontrada');
            document.getElementById('view-root').innerHTML = '<div class="alert alert-danger">Erro: CombinedView n√£o carregada</div>';
          }
        }

        if (name === 'zones') {
          if (typeof ZonesManagementView !== 'undefined') {
            await ZonesManagementView.render();
            currentView = ZonesManagementView;
          } else {
            console.error('ZonesManagementView n√£o encontrada');
            document.getElementById('view-root').innerHTML = '<div class="alert alert-danger">Erro: ZonesManagementView n√£o carregada</div>';
          }
        }
      }
    };

    // Inicializa√ß√£o quando DOM estiver pronto
    document.addEventListener('DOMContentLoaded', async function() {
      console.log('DOM carregado, inicializando sistema...');
      
      try {
        // GARANTIR LOGIN ANTES DE QUALQUER COISA
        let token = localStorage.getItem('token');
        
        if (!token || !AuthModel.isAuthenticated()) {
          console.log('üîê Fazendo login autom√°tico...');
          
          // LOGIN AUTOM√ÅTICO PARA DESENVOLVIMENTO/DISPOSITIVOS
          try {
            const autoLoginResponse = await fetch('http://localhost:3000/api/auth/device-login', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                deviceId: 'web_admin',
                deviceSecret: 'device_secret_web_admin'
              })
            });
            
            if (autoLoginResponse.ok) {
              const result = await autoLoginResponse.json();
              if (result.success && result.token) {
                localStorage.setItem('token', result.token);
                token = result.token;
                console.log('‚úÖ Login autom√°tico realizado - Token salvo');
              } else {
                throw new Error('Token n√£o retornado');
              }
            } else {
              const errorText = await autoLoginResponse.text();
              console.error('‚ùå Login falhou:', errorText);
              AuthView.renderLogin();
              return;
            }
          } catch (error) {
            console.error('‚ùå Erro no login autom√°tico:', error);
            AuthView.renderLogin();
            return;
          }
        }

        // Verificar se token √© v√°lido (pode ser que o token antigo exista mas esteja expirado)
        console.log('üîç Verificando validade do token...');
        const isTokenValid = await AuthModel.verifyToken();
        if (!isTokenValid) {
          console.log('‚ö†Ô∏è Token inv√°lido, removendo e fazendo novo login...');
          localStorage.removeItem('token');
          location.reload();
          return;
        }

        console.log('‚úÖ Token v√°lido, inicializando sistema...');

        // Usu√°rio autenticado - mostrar sistema principal
        await initializeMainSystem();
        
      } catch (error) {
        console.error('Erro na inicializa√ß√£o:', error);
        document.getElementById('view-root').innerHTML = `
          <div class="alert alert-danger">
            <h4>Erro na inicializa√ß√£o do sistema</h4>
            <p>${error.message}</p>
            <p class="small">Verifique o console para mais detalhes.</p>
          </div>
        `;
      }
    });

    // Fun√ß√£o para inicializar o sistema principal
    async function initializeMainSystem() {
      console.log('Inicializando sistema principal...');
      
      // Mostrar informa√ß√µes do usu√°rio
      const user = AuthModel.getUser();
      if (user) {
        document.getElementById('user-info').innerHTML = `
          <i class="bi bi-person-circle me-1"></i>${user.name} (${user.role})
        `;
        document.getElementById('logout-btn').style.display = 'inline-block';
      }

      // Verificar se a API est√° funcionando
      try {
        const response = await fetch('http://localhost:3000/api/status');
        if (response.ok) {
          const data = await response.json();
          console.log('‚úÖ API conectada:', data.message);
        } else {
          throw new Error('API n√£o est√° respondendo');
        }
      } catch (error) {
        console.error('‚ùå Erro ao conectar com a API:', error);
        document.getElementById('view-root').innerHTML = `
          <div class="alert alert-warning">
            <h4>‚ö†Ô∏è Problema de Conectividade</h4>
            <p>N√£o foi poss√≠vel conectar com o backend. Verifique se:</p>
            <ul>
              <li>O servidor Node.js est√° rodando (porta 3000)</li>
              <li>O MongoDB est√° ativo</li>
              <li>A URL da API est√° correta</li>
            </ul>
            <p><strong>Como resolver:</strong></p>
            <ol>
              <li>Abra um terminal na pasta backend</li>
              <li>Execute: <code>node server.js</code></li>
              <li>Recarregue esta p√°gina</li>
            </ol>
          </div>
        `;
        return;
      }
      
      // Inicializar controllers
      if (typeof MapController !== 'undefined') await MapController.init();
      if (typeof PeopleController !== 'undefined') PeopleController.init();
      if (typeof DevicesController !== 'undefined') DevicesController.init();

      // Configurar navega√ß√£o
      document.getElementById('nav-monitoring').addEventListener('click', () => Router.show('monitoring'));
      document.getElementById('nav-cadastro').addEventListener('click', () => Router.show('cadastro'));
      document.getElementById('nav-zones').addEventListener('click', () => Router.show('zones'));

      // Configurar logout
      document.getElementById('logout-btn').addEventListener('click', async () => {
        try {
          await AuthModel.logout();
          window.location.reload();
        } catch (error) {
          console.error('Erro no logout:', error);
          // Mesmo com erro, fazer logout local
          AuthModel.clearAuthData();
          window.location.reload();
        }
      });

      // Carregar view inicial - Central de Monitoramento
      await Router.show('monitoring');
      
      console.log('Sistema inicializado com sucesso');
    }

    // Tratamento de erros global
    window.addEventListener('error', function(e) {
      console.error('Erro global:', e.error);
    });
  </script>

  <!-- Header scroll effect: refor√ßa sombra/opacidade ao rolar -->
  <script>
    (function() {
      function applyHeaderScrollState() {
        var hdr = document.querySelector('header.navbar.bg-white');
        if (!hdr) return;
        if (window.scrollY > 2) hdr.classList.add('is-scrolled');
        else hdr.classList.remove('is-scrolled');
      }
      window.addEventListener('scroll', applyHeaderScrollState, { passive: true });
      window.addEventListener('load', applyHeaderScrollState);
    })();
  </script>
</body>
</html>